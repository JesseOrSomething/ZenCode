<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - ZenCode</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-links">
                <a href="index.html" class="nav-link">Chat</a>
                <a href="pricing.html" class="nav-link">Pricing</a>
                <a href="account.html" class="nav-link active">Account</a>
            </div>
        </nav>

        <!-- Account Content -->
        <div class="account-container">
            <div class="account-header">
                <h1>Account Management</h1>
                <p>Manage your subscription and get support</p>
            </div>

            <!-- User Info Section -->
            <div class="account-section">
                <h2>Account Information</h2>
                <div class="user-info">
                    <div class="info-item">
                        <span class="label">Email:</span>
                        <span class="value" id="userEmail">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Plan:</span>
                        <span class="value" id="userPlan">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Status:</span>
                        <span class="value" id="userStatus">Loading...</span>
                    </div>
                </div>
                <div class="account-actions">
                    <button id="logoutBtn" class="btn btn-danger">Log Out</button>
                </div>
            </div>

            <!-- Subscription Management -->
            <div class="account-section">
                <h2>Subscription Management</h2>
                <div class="subscription-info">
                    <div class="plan-details" id="planDetails">
                        <!-- Plan details will be populated by JavaScript -->
                    </div>
                    <div class="subscription-actions">
                        <button id="cancelSubscription" class="btn btn-danger" style="display: none;">
                            Cancel Subscription
                        </button>
                        <button id="upgradePlan" class="btn btn-primary" style="display: none;">
                            Upgrade to Pro
                        </button>
                        <button id="downgradePlan" class="btn btn-secondary" style="display: none;">
                            Downgrade to Free
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bug Reporting -->
            <div class="account-section">
                <h2>Report a Bug</h2>
                <p>Found an issue? Let us know and we'll fix it quickly!</p>
                <form id="bugReportForm" class="bug-report-form">
                    <div class="form-group">
                        <label for="bugSubject">Subject</label>
                        <input type="text" id="bugSubject" name="subject" placeholder="Brief description of the issue" required>
                    </div>
                    <div class="form-group">
                        <label for="bugDescription">Description</label>
                        <textarea id="bugDescription" name="description" placeholder="Please describe the bug in detail. Include steps to reproduce if possible." rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="bugEmail">Your Email</label>
                        <input type="email" id="bugEmail" name="email" placeholder="your@email.com" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Bug Report</button>
                </form>
            </div>

            <!-- Support Contact -->
            <div class="account-section">
                <h2>Need Help?</h2>
                <div class="support-info">
                    <p>For technical support or questions about your account:</p>
                    <div class="contact-methods">
                        <div class="contact-method">
                            <strong>Email:</strong> 
                            <a href="mailto:support@codecraftai.com" class="contact-link">support@codecraftai.com</a>
                        </div>
                        <div class="contact-method">
                            <strong>Response Time:</strong> Usually within 24 hours
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Account page specific JavaScript
        class AccountManager {
            constructor() {
                this.initializeAccount();
                this.setupEventListeners();
            }

            initializeAccount() {
                this.loadUserInfo();
                this.loadSubscriptionInfo();
            }

            loadUserInfo() {
                const user = localStorage.getItem('user');
                const token = localStorage.getItem('token');
                const selectedPlan = localStorage.getItem('selectedPlan');

                if (user && token) {
                    const userData = JSON.parse(user);
                    document.getElementById('userEmail').textContent = userData.email || 'Not available';
                    document.getElementById('userPlan').textContent = userData.subscription || selectedPlan || 'Free';
                    document.getElementById('userStatus').textContent = 'Active';
                } else {
                    document.getElementById('userEmail').textContent = 'Not logged in';
                    document.getElementById('userPlan').textContent = selectedPlan || 'Free';
                    document.getElementById('userStatus').textContent = 'Guest';
                }
            }

            loadSubscriptionInfo() {
                const user = localStorage.getItem('user');
                const token = localStorage.getItem('token');
                const selectedPlan = localStorage.getItem('selectedPlan');
                const planDetails = document.getElementById('planDetails');
                const cancelBtn = document.getElementById('cancelSubscription');
                const upgradeBtn = document.getElementById('upgradePlan');
                const downgradeBtn = document.getElementById('downgradePlan');

                if (user && token) {
                    const userData = JSON.parse(user);
                    const currentPlan = userData.subscription || selectedPlan || 'free';

                    if (currentPlan === 'pro') {
                        planDetails.innerHTML = `
                            <div class="plan-card pro-plan">
                                <h3>Pro Plan</h3>
                                <p>Unlimited coding questions</p>
                                <p>Advanced features</p>
                                <p>Priority support</p>
                                <p class="price">$17.49/month</p>
                            </div>
                        `;
                        cancelBtn.style.display = 'inline-block';
                        downgradeBtn.style.display = 'inline-block';
                    } else {
                        planDetails.innerHTML = `
                            <div class="plan-card free-plan">
                                <h3>Free Plan</h3>
                                <p>3 questions per day</p>
                                <p>Basic features</p>
                                <p>Community support</p>
                                <p class="price">Free</p>
                            </div>
                        `;
                        upgradeBtn.style.display = 'inline-block';
                    }
                } else {
                    planDetails.innerHTML = `
                        <div class="plan-card free-plan">
                            <h3>Free Plan</h3>
                            <p>3 questions per day</p>
                            <p>Basic features</p>
                            <p>Community support</p>
                            <p class="price">Free</p>
                        </div>
                    `;
                    upgradeBtn.style.display = 'inline-block';
                }
            }

            setupEventListeners() {
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Cancel subscription
                document.getElementById('cancelSubscription').addEventListener('click', () => {
                    if (confirm('Are you sure you want to cancel your subscription? You will lose access to Pro features immediately.')) {
                        this.cancelSubscription();
                    }
                });

                // Upgrade plan
                document.getElementById('upgradePlan').addEventListener('click', () => {
                    window.location.href = 'pricing.html';
                });

                // Downgrade plan
                document.getElementById('downgradePlan').addEventListener('click', () => {
                    if (confirm('Are you sure you want to downgrade to the Free plan? You will lose access to Pro features immediately.')) {
                        this.downgradePlan();
                    }
                });

                // Bug report form
                document.getElementById('bugReportForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitBugReport();
                });
            }

            async cancelSubscription() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/cancel-subscription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        alert('Subscription cancelled successfully. You have been downgraded to the Free plan.');
                        this.loadSubscriptionInfo();
                    } else {
                        alert('Error cancelling subscription. Please contact support.');
                    }
                } catch (error) {
                    console.error('Error cancelling subscription:', error);
                    alert('Error cancelling subscription. Please contact support.');
                }
            }

            async downgradePlan() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/subscription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ plan: 'free' })
                    });

                    if (response.ok) {
                        alert('Successfully downgraded to Free plan.');
                        // Update local storage
                        const user = JSON.parse(localStorage.getItem('user'));
                        user.subscription = 'free';
                        localStorage.setItem('user', JSON.stringify(user));
                        this.loadSubscriptionInfo();
                    } else {
                        alert('Error downgrading plan. Please contact support.');
                    }
                } catch (error) {
                    console.error('Error downgrading plan:', error);
                    alert('Error downgrading plan. Please contact support.');
                }
            }

            logout() {
                // Clear local storage
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                localStorage.removeItem('selectedPlan');
                
                // Redirect to home page
                window.location.href = 'index.html';
            }

            async submitBugReport() {
                const form = document.getElementById('bugReportForm');
                const formData = new FormData(form);
                
                const bugReport = {
                    subject: formData.get('subject'),
                    description: formData.get('description'),
                    email: formData.get('email'),
                    timestamp: new Date().toISOString()
                };

                try {
                    // For now, we'll just show a success message
                    // In a real app, this would send to your backend
                    alert('Bug report submitted successfully! We\'ll get back to you within 24 hours.');
                    form.reset();
                } catch (error) {
                    console.error('Error submitting bug report:', error);
                    alert('Error submitting bug report. Please try again or contact support directly.');
                }
            }
        }

        // Initialize account manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AccountManager();
        });
    </script>
</body>
</html>